<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>ezze | screenshot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
  <style>
    #background {
      position: relative;
    }

    #mouse-location {
      position: absolute;
      z-index: 9999;
      background: #ffffff;
      width: 50px;
      height: 15px;
      font-size: 10px;

      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
    }

    #cover-app-screen {
      position: absolute;
      left: 0;
      top: 0;
    }

    #selected-region {
      position: absolute;
      background-color: black;
    }

    #function-menu {
      position: absolute;
      z-index: 9999;
      background-color: beige;

      display: flex;
      flex-direction: row-reverse;
      align-items: center;
    }

    .function-name {
      font-size: 10px;
      padding: 0 5px 0 5px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 2px 0 2px;

      border-radius: 2px;
      cursor: pointer;
      /* border: 1px solid #ffffff; */
    }

    .function-name:hover {
      /* border: 1px solid #111111; */
      color: #409EFF;
    }
  </style>
</head>

<body>
  <script type="text/babel">
    class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          screenshotPath: '',
          canvasWidth: 0,
          canvasHeight: 0,
          mouseX: 0,
          mouseY: 0,
          selecting: false,
          start: false,
          end: undefined
        }
        this.rate = 0.7;
        this.renderMouseLocation = this.renderMouseLocation.bind(this);
        this.renderFunction = this.renderFunction.bind(this);
      }

      componentDidMount() {
        const SCREEN_SHOT_NANE = 'ezze_temp_screenshot.png';
        this.screenshotPath = `${process.cwd()}/${SCREEN_SHOT_NANE}`;

        this.screenshotPng = new Image();
        this.screenshotPng.src = this.screenshotPath;

        // 截图
        this.appCanvas = document.getElementById('app-canvas');

        // 蒙层
        this.coverApp = document.getElementById('cover-app-screen');
        this.coverAppCanvas = document.getElementById('cover-app-screen').getContext('2d');

        // 鼠标
        this.mouse = document.getElementById('mouse-location');

        // this.selectedRegion = document.getElementById('selected-region');
        // this.selectedRegionCanvas = document.getElementById('selected-region').getContext('2d');


        this.fillScreenshot();
        this.drawMouseMove();

        // 是否结束
        this.isEnd = false;
      }

      // 画截图和顶部蒙层
      fillScreenshot() {
        const createCanvas = this.appCanvas.getContext('2d');
        const img = new Image();
        img.src = this.screenshotPath;
        img.onload = () => {
          // 展示在页面上的图片的宽和高
          const showImgWidth = img.width * this.rate;
          const showImgHeight = img.height * this.rate;

          this.setState({
            canvasWidth: showImgWidth,
            canvasHeight: showImgHeight
          })

          createCanvas.drawImage(img, 0, 0, showImgWidth, showImgHeight);
        };
      }

      // 画裁剪后的图片
      drawTailorImg() {
        const selectedScreenImg = document.getElementById('selected-screen').getContext('2d');
        const image = new Image();
        // images.src = t.imgUrl;
        // image.src = 截图之后的图片路径，显示在左上角

      }

      drawMouseMove() {
        this.coverApp.onmousedown = (e) => {

          const { canvasWidth, canvasHeight } = this.state;

          if (!this.isEnd) {
            console.log('按下', e);
            // 画蒙层
            this.coverAppCanvas.fillStyle = "rgba(0, 0, 0, 0.5)";
            // fillRect 画矩形
            this.coverAppCanvas.fillRect(0, 0, canvasWidth, canvasHeight);
            const { pageX, pageY } = e;
            // 左上角x y坐标
            this.setState({
              cornerTopLeftX: pageX,
              cornerTopLeftY: pageY,
              selecting: true,
              start: true,
            });
          }
        }

        this.coverApp.onmouseup = (e) => {
          const { cornerTopLeftX, cornerTopLeftY } = this.state;
          if (!this.isEnd) {
            console.log('松手', e);
            const { pageX, pageY } = e;
            this.setState({
              cornerDownRightX: pageX,
              cornerDownRightY: pageY,
              selecting: false,
              end: true
            });

            // 松手之后清除掉鼠标移动函数
            this.coverApp.onmousemove = undefined;
          }
          this.isEnd = true;
        }

        this.coverApp.onmousemove = (e) => {
          const { pageX, pageY, mouseX, mouseY } = e;
          const { selecting } = this.state;
          if (selecting) {
            const { cornerTopLeftX, cornerTopLeftY } = this.state;
            // 只能往右下
            this.coverAppCanvas.clearRect(cornerTopLeftX, cornerTopLeftY, pageX - cornerTopLeftX, pageY - cornerTopLeftY);
          }
          // console.log(pageX, mouseX, pageY, mouseY);
          if (pageX < mouseX || pageY < mouseY) {
            if (pageX < mouseX) {
              console.log('左移');
            }
            if (pageY < mouseY) {
              console.log('上移');
            }
          }
          this.setState({
            mouseX: pageX,
            mouseY: pageY,
          });
        }
      }

      // 截图中
      selecting(e) {
        const { pageX, pageY, mouseX, mouseY } = e;
        const { selecting } = this.state;
        if (selecting) {
          const { cornerTopLeftX, cornerTopLeftY } = this.state;
          // 只能往右下
          this.coverAppCanvas.clearRect(cornerTopLeftX, cornerTopLeftY, pageX - cornerTopLeftX, pageY - cornerTopLeftY);
        }
        // console.log(pageX, mouseX, pageY, mouseY);
        if (pageX < mouseX || pageY < mouseY) {
          if (pageX < mouseX) {
            console.log('左移');
          }
          if (pageY < mouseY) {
            console.log('上移');
          }
        }
        this.setState({
          mouseX: pageX,
          mouseY: pageY,
        });
      }

      renderMouseLocation() {
        const { selecting, start, mouseX, mouseY, cornerTopLeftX, cornerTopLeftY } = this.state;
        // 拖动中开始展示

        // 拖动结束也展示
        if (start) {
          return (
            <div id="mouse-location" style={{ left: cornerTopLeftX, top: cornerTopLeftY - 20 }}>
              {`${mouseX} x ${mouseY}`}
            </div>
          );
        }
        return null;
      }

      renderFunction() {
        const { isEnd } = this;
        const { end, cornerDownRightX, cornerDownRightY, cornerTopLeftX, cornerTopLeftY } = this.state;
        if (end) {
          return (
            <div id="function-menu" style={{ background: '#ffffff', width: cornerDownRightX - cornerTopLeftX, height: 22, top: cornerDownRightY + 2, left: cornerTopLeftX, borderRadius: 4 }}>
              <div className="function-name">
                翻译
              </div>
              <div style={{ width: 0.5, height: '50%', margin: '0 2px 0 2px', background: '#e6e6e6' }}>
              </div>
              <div className="function-name">
                关闭
              </div>
            </div>
          )
        }
        return null;
      }

      render() {
              // <image className="function-name" src="./asserts/close.png" style={{ width: 20, height: 20 }}></image>
        // <canvas id="selected-region" style={{ left: cornerTopLeftX, top: cornerTopLeftY, width: cornerDownRightX - cornerTopLeftX, height: cornerDownRightY - cornerTopLeftY }}>
        //     </canvas>
        const { screenshotPath, canvasWidth, canvasHeight, mouseX, mouseY, cornerTopLeftX, cornerTopLeftY, cornerDownRightX, cornerDownRightY } = this.state;
        return (
          <div id="background">
            {this.renderMouseLocation()}
            {this.renderFunction()}
            <canvas id="cover-app-screen" width={canvasWidth} height={canvasHeight}>
            </canvas>
            <canvas id='app-canvas' width={canvasWidth} height={canvasHeight}>
            </canvas>
          </div >
        )
      }
    }

    React.render(<App />,
      document.getElementById('app')
    );
  </script>
  <div id="app"></div>
</body>

</html>